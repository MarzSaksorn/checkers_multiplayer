<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏´‡∏°‡∏≤‡∏Å‡∏Æ‡∏≠‡∏™ ‡∏Å‡∏π‡πâ‡πÇ‡∏•‡∏Å‡∏°‡∏´‡∏±‡∏ô‡∏ï‡∏†‡∏±‡∏¢</title>
  <script  src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #ffffff;
      overflow: auto;
    }

    html, body, #app-wrapper {
      height: 100%;
      width: 100%;
    }

    #app-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .game-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .game-title {
      font-size: 48px;
      font-weight: bold;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .mode-selection {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .mode-btn {
      padding: 15px 30px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .mode-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.4);
    }

    .local-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .online-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .lobby-container {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      backdrop-filter: blur(10px);
    }

    .lobby-header {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      background: rgba(255,255,255,0.9);
      color: #333;
      box-sizing: border-box;
    }

    .btn {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 10px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .lobby-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .lobby-item {
      background: rgba(255,255,255,0.15);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .lobby-item-info {
      flex: 1;
    }

    .lobby-item-name {
      font-weight: bold;
      font-size: 18px;
    }

    .join-btn {
      padding: 8px 20px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .join-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .waiting-message {
      text-align: center;
      padding: 20px;
      font-size: 18px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .game-info {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 640px;
      gap: 20px;
    }

    .team-info {
      flex: 1;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .water-team {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: #003d5c;
    }

    .fire-team {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: #5c1f00;
    }

    .team-name {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .team-status {
      font-size: 16px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(8, 80px);
      grid-template-rows: repeat(8, 80px);
      gap: 0;
      border: 4px solid #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
    }

    .square {
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    .square.light {
      background: #f0d9b5;
    }

    .square.dark {
      background: #b58863;
    }

    .square.selected {
      background: #7fc97f !important;
      box-shadow: inset 0 0 20px rgba(0,255,0,0.5);
    }

    .square.valid-move {
      background: #ffffaa !important;
    }

    .square.valid-move::after {
      content: '';
      width: 20px;
      height: 20px;
      background: rgba(255,255,0,0.5);
      border-radius: 50%;
      position: absolute;
    }

    .piece {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      transition: all 0.3s;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .piece:hover {
      transform: scale(1.1);
    }

    .piece.water {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .piece.fire {
      background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
    }

    .piece.king {
      box-shadow: 0 0 15px gold, 0 4px 8px rgba(0,0,0,0.3);
      border: 3px solid gold;
    }

    .back-btn {
      padding: 10px 25px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .game-over-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .game-over-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .game-over-title {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .game-over-message {
      font-size: 24px;
      margin-bottom: 30px;
    }

    .loading-spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    .toast-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      border-radius: 8px;
      z-index: 2000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      font-weight: bold;
      animation: slideDown 0.3s ease;
    }

    .toast-error {
      background: #ff6b6b;
      color: white;
    }

    .toast-success {
      background: #51cf66;
      color: white;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      .board {
        grid-template-columns: repeat(8, 50px);
        grid-template-rows: repeat(8, 50px);
      }

      .square {
        width: 50px;
        height: 50px;
      }

      .piece {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .game-title {
        font-size: 32px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script  src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="app-wrapper"></div>
  <script>
    const defaultConfig = {
      game_title: "‡∏´‡∏°‡∏≤‡∏Å‡∏Æ‡∏≠‡∏™ ‡∏Å‡∏π‡πâ‡πÇ‡∏•‡∏Å‡∏°‡∏´‡∏±‡∏ô‡∏ï‡∏†‡∏±‡∏¢",
      water_team_label: "‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏ô‡πâ‡∏≥",
      fire_team_label: "‡πÑ‡∏ü ‡πÅ‡∏•‡∏∞ ‡∏ù‡∏ô‡∏Å‡∏£‡∏î",
      api_endpoint: "https://nodejs.marzweb.win/api",
      background_color: "#1e3c72",
      surface_color: "#2a5298",
      text_color: "#ffffff",
      primary_action_color: "#667eea",
      secondary_action_color: "#f093fb"
    };

    let currentMode = null;
    let gameState = null;
    let selectedPiece = null;
    let currentLobbyId = null;
    let playerName = null;
    let isHost = false;
    let pollingInterval = null;

    // API helper functions
    function getApiEndpoint() {
      const config = window.elementSdk?.config || defaultConfig;
      return config.api_endpoint || defaultConfig.api_endpoint;
    }

    function showToast(message, type = 'error') {
      const toast = document.createElement('div');
      toast.className = `toast-message toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function apiRequest(endpoint, method = 'GET', data = null) {
      try {
        const options = {
          method,
          headers: { 'Content-Type': 'application/json' }
        };
        if (data) options.body = JSON.stringify(data);

        // This ensures IDs with spaces or symbols are sent correctly
        const url = `${getApiEndpoint()}${endpoint}`;
        const response = await fetch(url, options);
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error('API request failed:', error);
        showToast('Connection failed', 'error');
        throw error;
      }
    }

    async function onConfigChange(config) {
      const title = document.getElementById('main-title');
      if (title) {
        title.textContent = config.game_title || defaultConfig.game_title;
      }

      const waterLabel = document.querySelectorAll('.water-label');
      waterLabel.forEach(el => {
        el.textContent = config.water_team_label || defaultConfig.water_team_label;
      });

      const fireLabel = document.querySelectorAll('.fire-label');
      fireLabel.forEach(el => {
        el.textContent = config.fire_team_label || defaultConfig.fire_team_label;
      });

      document.body.style.background = `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, ${config.surface_color || defaultConfig.surface_color} 100%)`;
    }

    function initializeGame() {
      const board = [];
      for (let row = 0; row < 8; row++) {
        board[row] = [];
        for (let col = 0; col < 8; col++) {
          board[row][col] = null;
        }
      }

      for (let row = 0; row < 3; row++) {
        for (let col = 0; col < 8; col++) {
          if ((row + col) % 2 === 1) {
            board[row][col] = { 
              type: 'water', 
              king: false,
              isKnight: true
            };
          }
        }
      }

      for (let row = 5; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          if ((row + col) % 2 === 1) {
            board[row][col] = { 
              type: 'fire', 
              king: false,
              isAcidRain: row === 7
            };
          }
        }
      }

      return {
        board: board,
        currentTurn: 'water',
        gameOver: false,
        winner: null
      };
    }

    function getValidMoves(row, col, board) {
      const piece = board[row][col];
      if (!piece) return [];

      const moves = [];
      const directions = piece.king 
        ? [[-2, -2], [-2, 2], [2, -2], [2, 2], [-1, -1], [-1, 1], [1, -1], [1, 1]]
        : piece.type === 'water' 
          ? [[1, -1], [1, 1]]
          : [[-1, -1], [-1, 1]];

      for (const [dRow, dCol] of directions) {
        const newRow = row + dRow;
        const newCol = col + dCol;

        if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
          if (!board[newRow][newCol]) {
            moves.push({ row: newRow, col: newCol, type: 'move' });
          } else if (board[newRow][newCol].type !== piece.type) {
            const jumpRow = row + dRow * 2;
            const jumpCol = col + dCol * 2;
            if (jumpRow >= 0 && jumpRow < 8 && jumpCol >= 0 && jumpCol < 8 && !board[jumpRow][jumpCol]) {
              moves.push({ row: jumpRow, col: jumpCol, type: 'jump', capturedRow: newRow, capturedCol: newCol });
            }
          }
        }
      }

      //if (piece.isAcidRain && !piece.king) {
      //  for (const [dRow, dCol] of [[-2, -2], [-2, 2]]) {
//          const newRow = row + dRow;
//          const newCol = col + dCol;
//          if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8 && !board[newRow][newCol]) {
//            const path1Row = row + dRow / 2;
//            const path1Col = col + dCol / 2;
//            if (!board[path1Row][path1Col]) {
//              moves.push({ row: newRow, col: newCol, type: 'move' });
//            }
//        }
//        }
//      }

      return moves;
    }

    function movePiece(fromRow, fromCol, toRow, toCol, board) {
      const piece = board[fromRow][fromCol];
      
      // IMPORTANT: Calculate valid moves BEFORE moving the piece
      const validMoves = getValidMoves(fromRow, fromCol, board);
      const move = validMoves.find(m => m.row === toRow && m.col === toCol);

      // Move the piece
      board[toRow][toCol] = piece;
      board[fromRow][fromCol] = null;

      // Remove captured piece if this was a jump
      if (move && move.type === 'jump') {
        board[move.capturedRow][move.capturedCol] = null;
      }

      // Check for king promotion
      if ((piece.type === 'water' && toRow === 7) || (piece.type === 'fire' && toRow === 0)) {
        piece.king = true;
      }

      return board;
    }

    function checkWinner(board) {
      let waterCount = 0;
      let fireCount = 0;
      let waterCanMove = false;
      let fireCanMove = false;

      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const piece = board[row][col];
          if (piece) {
            if (piece.type === 'water') {
              waterCount++;
              if (getValidMoves(row, col, board).length > 0) waterCanMove = true;
            } else {
              fireCount++;
              if (getValidMoves(row, col, board).length > 0) fireCanMove = true;
            }
          }
        }
      }

      if (waterCount === 0 || !waterCanMove) return 'fire';
      if (fireCount === 0 || !fireCanMove) return 'water';
      return null;
    }

    function renderBoard() {
      const container = document.getElementById('app-wrapper');
      const config = window.elementSdk?.config || defaultConfig;

      let html = `
        <div class="game-container">
          <button class="back-btn" onclick="backToMenu()">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
          <div class="game-header">
            <h1 class="game-title" id="main-title">${config.game_title || defaultConfig.game_title}</h1>
          </div>
          <div class="game-info">
            <div class="team-info water-team">
              <div class="team-name water-label">${config.water_team_label || defaultConfig.water_team_label}</div>
              <div class="team-status">${gameState.currentTurn === 'water' ? '‚öîÔ∏è ‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì' : 'Waiting...'}</div>
            </div>
            <div class="team-info fire-team">
              <div class="team-name fire-label">${config.fire_team_label || defaultConfig.fire_team_label}</div>
              <div class="team-status">${gameState.currentTurn === 'fire' ? 'üî• ‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì' : 'Waiting...'}</div>
            </div>
          </div>
          <div class="board" id="game-board">
      `;

      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const isLight = (row + col) % 2 === 0;
          const piece = gameState.board[row][col];
          const isSelected = selectedPiece && selectedPiece.row === row && selectedPiece.col === col;
          const validMoves = selectedPiece ? getValidMoves(selectedPiece.row, selectedPiece.col, gameState.board) : [];
          const isValidMove = validMoves.some(m => m.row === row && m.col === col);

          html += `
            <div class="square ${isLight ? 'light' : 'dark'} ${isSelected ? 'selected' : ''} ${isValidMove ? 'valid-move' : ''}"
                 onclick="handleSquareClick(${row}, ${col})">
          `;

          if (piece) {
            let emoji = piece.isKnight ? '‚ôû' : (piece.isAcidRain ? '‚ò†Ô∏è' : (piece.type === 'water' ? 'üíß' : 'üî•'));
            if (piece.king && !piece.isAcidRain) emoji = piece.type === 'water' ? 'üëë' : 'üåü';
            
            html += `
              <div class="piece ${piece.type} ${piece.king ? 'king' : ''}">
                ${emoji}
              </div>
            `;
          }

          html += `</div>`;
        }
      }

      html += `</div></div>`;

      if (gameState.gameOver) {
        const winnerTeam = gameState.winner === 'water' 
          ? (config.water_team_label || defaultConfig.water_team_label)
          : (config.fire_team_label || defaultConfig.fire_team_label);
        html += `
          <div class="game-over-overlay">
            <div class="game-over-content">
              <div class="game-over-title">üèÜ ‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</div>
              <div class="game-over-message">${winnerTeam} ‡∏ä‡∏ô‡∏∞!</div>
              <button class="btn btn-primary" onclick="backToMenu()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    async function handleSquareClick(row, col) {
      if (gameState.gameOver) return;

      if (currentMode === 'online') {
        const myTurn = (isHost && gameState.currentTurn === 'water') || (!isHost && gameState.currentTurn === 'fire');
        if (!myTurn) return;
      }

      const piece = gameState.board[row][col];

      if (selectedPiece) {
        const validMoves = getValidMoves(selectedPiece.row, selectedPiece.col, gameState.board);
        const validMove = validMoves.find(m => m.row === row && m.col === col);

        if (validMove) {
          gameState.board = movePiece(selectedPiece.row, selectedPiece.col, row, col, gameState.board);
          gameState.currentTurn = gameState.currentTurn === 'water' ? 'fire' : 'water';
          selectedPiece = null;

          const winner = checkWinner(gameState.board);
          if (winner) {
            gameState.gameOver = true;
            gameState.winner = winner;
          }

          if (currentMode === 'online') {
            await updateOnlineGame();
          }

          renderBoard();
        } else {
          selectedPiece = null;
          renderBoard();
        }
      } else if (piece && piece.type === gameState.currentTurn) {
        selectedPiece = { row, col };
        renderBoard();
      }
    }

    function showModeSelection() {
      const container = document.getElementById('app-wrapper');
      const config = window.elementSdk?.config || defaultConfig;

      container.innerHTML = `
        <div class="game-header">
          <h1 class="game-title" id="main-title">${config.game_title || defaultConfig.game_title}</h1>
        </div>
        <div class="mode-selection">
          <button class="mode-btn local-btn" onclick="startLocalGame()">üéÆ 2 ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
          <button class="mode-btn online-btn" onclick="showLobbyMenu()">üåê ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</button>
        </div>
      `;
    }

    function startLocalGame() {
      currentMode = 'local';
      gameState = initializeGame();
      selectedPiece = null;
      renderBoard();
    }

    function showLobbyMenu() {
      const container = document.getElementById('app-wrapper');
      const config = window.elementSdk?.config || defaultConfig;

      container.innerHTML = `
        <div class="lobby-container">
          <button class="back-btn" onclick="backToMenu()">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
          <div class="lobby-header">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
          <div class="input-group">
            <label for="player-name-input">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
            <input type="text" id="player-name-input" placeholder="‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" value="${playerName || ''}">
          </div>
          <button class="btn btn-primary" onclick="createLobby()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏°</button>
          <button class="btn btn-secondary" onclick="refreshLobbies()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ</button>
          <div class="lobby-list" id="lobby-list">
            <div class="loading-spinner"></div>
          </div>
        </div>
      `;

      refreshLobbies();
    }

    async function createLobby() {
      const nameInput = document.getElementById('player-name-input');
      playerName = nameInput.value.trim();
      if (!playerName) return showToast('Please enter your name');

      // Generate a cleaner ID without spaces
      currentLobbyId = `lobby-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
      isHost = true;
      gameState = initializeGame();

      try {
        await apiRequest('/lobbies', 'POST', {
          lobby_id: currentLobbyId,
          player_name: playerName,
          game_state: JSON.stringify(gameState),
          current_turn: 'water'
        });
        showWaitingRoom();
        startPolling();
      } catch (e) { console.error(e); }
    }

    async function refreshLobbies() {
      const listContainer = document.getElementById('lobby-list');
      if (!listContainer) return;

      listContainer.innerHTML = '<div class="loading-spinner"></div>';

      try {
        const lobbies = await apiRequest('/lobbies', 'GET');
        const waitingLobbies = lobbies.filter(l => l.status === 'waiting');

        if (waitingLobbies.length === 0) {
          listContainer.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.7);">No games available. Create one!</div>';
        } else {
          listContainer.innerHTML = waitingLobbies.map(lobby => `
            <div class="lobby-item">
              <div class="lobby-item-info">
                <div class="lobby-item-name">${lobby.host_name || 'Player'}'s Game</div>
              </div>
              <button class="join-btn" onclick="joinLobby('${lobby.lobby_id}')">Join</button>
            </div>
          `).join('');
        }
      } catch (error) {
        listContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#ff6b6b;">Failed to load lobbies</div>';
      }
    }

    async function joinLobby(lobbyId) {
      const nameInput = document.getElementById('player-name-input');
      playerName = nameInput.value.trim();
      if (!playerName) return showToast('Please enter your name');

      currentLobbyId = lobbyId;
      isHost = false;

      try {
        // We use encodeURIComponent here just in case the ID has spaces
        const encodedId = encodeURIComponent(lobbyId);
        const lobby = await apiRequest(`/lobbies/${encodedId}`, 'GET');
        gameState = JSON.parse(lobby.game_state);

        await apiRequest(`/lobbies/${encodedId}/join`, 'POST', {
          player_name: playerName
        });

        currentMode = 'online';
        startPolling();
        renderBoard();
      } catch (e) { console.error(e); }
    }

    function showWaitingRoom() {
      const container = document.getElementById('app-wrapper');

      container.innerHTML = `
        <div class="lobby-container">
          <div class="lobby-header">Waiting for Player...</div>
          <div class="waiting-message">
            Game ID: ${currentLobbyId}<br>
            Share this with your friend!
          </div>
          <div class="loading-spinner"></div>
          <button class="btn btn-secondary" onclick="cancelLobby()">Cancel</button>
        </div>
      `;
    }

    async function cancelLobby() {
      stopPolling();
      try {
        await apiRequest(`/lobbies/${currentLobbyId}`, 'DELETE');
      } catch (error) {
        // Ignore error
      }
      currentLobbyId = null;
      isHost = false;
      showLobbyMenu();
    }

    async function updateOnlineGame() {
      const encodedId = encodeURIComponent(currentLobbyId);
      await apiRequest(`/lobbies/${encodedId}`, 'PUT', {
        game_state: JSON.stringify(gameState),
        current_turn: gameState.currentTurn
      });
    }

    function startPolling() {
      if (pollingInterval) clearInterval(pollingInterval);
      pollingInterval = setInterval(checkGameUpdates, 2000);
    }

    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    async function checkGameUpdates() {
      if (!currentLobbyId) return;
      try {
        const encodedId = encodeURIComponent(currentLobbyId);
        const lobby = await apiRequest(`/lobbies/${encodedId}`, 'GET');
        
        if (lobby.status === 'playing') {
          const newGameState = JSON.parse(lobby.game_state);
          if (JSON.stringify(newGameState) !== JSON.stringify(gameState)) {
            gameState = newGameState;
            renderBoard();
          }
          if (isHost && currentMode !== 'online') {
            currentMode = 'online';
            renderBoard();
          }
        }
      } catch (e) { console.error(e); }
    }

    function backToMenu() {
      stopPolling();
      currentMode = null;
      gameState = null;
      selectedPiece = null;
      currentLobbyId = null;
      showModeSelection();
    }

    function init() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  config.primary_action_color = value;
                  window.elementSdk.setConfig({ primary_action_color: value });
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  config.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["game_title", config.game_title || defaultConfig.game_title],
            ["water_team_label", config.water_team_label || defaultConfig.water_team_label],
            ["fire_team_label", config.fire_team_label || defaultConfig.fire_team_label],
            ["api_endpoint", config.api_endpoint || defaultConfig.api_endpoint]
          ])
        });
      }

      showModeSelection();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9adc40f361e57322',t:'MTc2NTcwMDEzMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>